<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PULSE Benchmark Leaderboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 2em;
        background-color: #f0f2f5;
      }
      h1 {
        color: #222;
        font-size: 2rem;
        margin-bottom: 0.5em;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        align-items: center;
        margin-bottom: 2em;
      }
      input,
      select,
      button {
        padding: 0.5em;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1em;
      }
      select#taskFilter {
        min-width: 140px;
      } /* widen All Tasks button */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
      }
      th,
      td {
        padding: 12px 15px;
        text-align: left;
      }
      th {
        background-color: #f5f5f5;
        cursor: pointer;
      }
      tr:nth-child(even) {
        background-color: #fafafa;
      }
      .dataset-section {
        margin-top: 2em;
      }
      .chart-container {
        width: 100%;
        max-width: 800px;
        margin-top: 2em;
      }
      footer {
        margin-top: 4em;
        text-align: center;
        color: #777;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <h1>PULSE Benchmark Leaderboard</h1>
    <p>Live leaderboard for AKI, Sepsis, and Mortality prediction tasks.</p>

    <div class="controls">
      <input type="text" id="search" placeholder="Search model or task..." />
      <select id="taskFilter">
        <option value="">All Tasks</option>
        <option value="AKI">AKI</option>
        <option value="Sepsis">Sepsis</option>
        <option value="Mortality">Mortality</option>
      </select>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>

    <div id="leaderboards"></div>
    <div class="chart-container">
      <canvas id="auprcChart"></canvas>
    </div>

    <footer>
      <p>
        Maintained by
        <a href="https://github.com/j4nberner/pulse" target="_blank"
          >PULSE @ GitHub</a
        >
      </p>
    </footer>

    <script>
      let allData = [];
      let currentSort = { key: "", asc: true };

      fetch("results.json")
        .then((response) => response.json())
        .then((json) => {
          allData = json.results;
          updatePage();
        })
        .catch((err) => console.error("Error loading results:", err));

      function updatePage() {
        const datasets = Array.from(new Set(allData.map((e) => e.dataset)));
        const container = document.getElementById("leaderboards");
        container.innerHTML = "";

        const filtered = getFilteredSortedData();

        datasets.forEach((dataset) => {
          const section = document.createElement("div");
          section.className = "dataset-section";
          const title = document.createElement("h2");
          title.textContent = `Dataset: ${dataset}`;
          section.appendChild(title);

          const table = document.createElement("table");
          table.innerHTML = `
          <thead>
            <tr>
              <th>Model</th>
              <th>Task</th>
              <th>AUROC</th>
              <th>AUPRC</th>
              <th>Balanced Accuracy</th>
            </tr>
          </thead>
          <tbody>
            ${filtered
              .filter((e) => e.dataset === dataset)
              .map((entry) => {
                const m = entry.metrics_summary.overall;
                return `<tr>
                <td>${entry.model_id}</td>
                <td>${entry.task_id}</td>
                <td>${m.auroc?.toFixed(3)}</td>
                <td>${m.auprc?.toFixed(3)}</td>
                <td>${m.balanced_accuracy?.toFixed(3)}</td>
              </tr>`;
              })
              .join("")}
          </tbody>
        `;
          section.appendChild(table);
          container.appendChild(section);
        });

        renderChart(filtered);
      }

      function getFilteredSortedData() {
        const search = document.getElementById("search").value.toLowerCase();
        const task = document.getElementById("taskFilter").value.toLowerCase();
        let filtered = allData.filter(
          (entry) =>
            (!task || entry.task_id.toLowerCase() === task) &&
            (entry.model_id.toLowerCase().includes(search) ||
              entry.task_id.toLowerCase().includes(search))
        );

        if (currentSort.key) {
          filtered.sort((a, b) => {
            let valA = a[currentSort.key];
            let valB = b[currentSort.key];
            if (
              ["auroc", "auprc", "balanced_accuracy"].includes(currentSort.key)
            ) {
              valA = a.metrics_summary.overall[currentSort.key];
              valB = b.metrics_summary.overall[currentSort.key];
            }
            if (typeof valA === "string")
              return currentSort.asc
                ? valA.localeCompare(valB)
                : valB.localeCompare(valA);
            return currentSort.asc ? valA - valB : valB - valA;
          });
        }
        return filtered;
      }

      document.getElementById("search").addEventListener("input", updatePage);
      document
        .getElementById("taskFilter")
        .addEventListener("change", updatePage);

      function downloadCSV() {
        const data = getFilteredSortedData();
        const header = [
          "Model",
          "Task",
          "Dataset",
          "AUROC",
          "AUPRC",
          "Balanced Accuracy",
        ];
        const rows = data.map((e) => [
          e.model_id,
          e.task_id,
          e.dataset,
          e.metrics_summary.overall.auroc,
          e.metrics_summary.overall.auprc,
          e.metrics_summary.overall.balanced_accuracy,
        ]);
        const csv = [header, ...rows].map((e) => e.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "leaderboard.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function renderChart(data) {
        const ctx = document.getElementById("auprcChart")?.getContext("2d");
        if (!ctx) return;
        const models = data.map((e) => `${e.model_id} (${e.task_id})`);
        const values = data.map((e) => e.metrics_summary.overall.auprc);
        if (window.auprcChart) window.auprcChart.destroy();
        window.auprcChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: models,
            datasets: [
              {
                label: "AUPRC",
                data: values,
                backgroundColor: "#4e79a7",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: "AUPRC per Model",
              },
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "AUPRC" } },
            },
          },
        });
      }
    </script>
  </body>
</html>
